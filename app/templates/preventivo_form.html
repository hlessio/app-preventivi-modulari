{% extends "base.html" %}

{% block title %}{% if preventivo_id %}Modifica{% else %}Nuovo{% endif %} Preventivo - App Preventivi{% endblock %}

{% block extra_head %}
<style>
    .form-section {
        transition: all 0.3s ease;
    }
    .form-section:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .anteprima-container {
        /* Rimosso max-height e overflow-y */
    }
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: white;
        border-bottom: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<div x-data="preventivoForm()" class="flex flex-col h-screen">
    <!-- Header con Azioni -->
    <div class="sticky-header bg-white -mx-4 px-4 py-4 border-b z-10">
        <div class="flex items-center justify-between max-w-7xl mx-auto">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">
                    {% if preventivo_id %}
                        Modifica Preventivo
                    {% else %}
                        Nuovo Preventivo
                    {% endif %}
                </h1>
                <p class="text-sm text-gray-500 mt-1">
                    <span x-show="formData.numero_preventivo" x-text="`Numero: ${formData.numero_preventivo}`"></span>
                    <span x-show="!formData.numero_preventivo">Compilare i campi per creare il preventivo</span>
                </p>
            </div>
            
            <!-- Azioni -->
            <div class="flex items-center space-x-3">
                <!-- Stato -->
                <select x-model="formData.stato_preventivo" 
                        class="rounded-md border-gray-300 text-sm focus:border-blue-500 focus:ring-blue-500">
                    <option value="bozza">Bozza</option>
                    <option value="inviato">Inviato</option>
                    <option value="approvato">Approvato</option>
                    <option value="rifiutato">Rifiutato</option>
                </select>

                <!-- Pulsanti -->
                <button x-on:click="salvaPreventivo('bozza')" 
                        :disabled="salvando"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                    <i class="fas fa-save mr-2" :class="{'fa-spin': salvando}"></i>
                    <span x-text="salvando ? 'Salvando...' : 'Salva Bozza'"></span>
                </button>
                
                <button x-on:click="anteprimaPreventivo()" 
                        class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-eye mr-2"></i>
                    Anteprima
                </button>

                <a href="/" 
                   class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Torna alla Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="flex flex-grow overflow-hidden">
        <!-- Sidebar Sinistra: Controlli Form -->
        <div class="w-1/3 bg-gray-50 border-r border-gray-200 overflow-y-auto">
            <div class="p-6 space-y-6">
                <!-- 1. Dati Azienda (Read-only, precaricati) -->
                <div class="form-section bg-white rounded-lg shadow border border-gray-200 p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-building text-blue-600 mr-2"></i>
                        Dati Azienda
                    </h3>
                    <div class="bg-gray-50 rounded-md p-4">
                        <div class="grid grid-cols-1 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">Ragione Sociale:</span>
                                <div x-text="formData.intestazione_azienda.ragione_sociale || 'La Tua Azienda S.r.l.'"></div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">P.IVA:</span>
                                <div x-text="formData.intestazione_azienda.partita_iva || '12345678901'"></div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Indirizzo:</span>
                                <div x-text="formData.intestazione_azienda.indirizzo || 'Via Roma 123, 00100 Roma'"></div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">Telefono:</span>
                                <div x-text="formData.intestazione_azienda.telefono || '+39 06 1234567'"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            I dati aziendali vengono caricati dal tuo profilo
                        </p>
                    </div>
                </div>

                <!-- 2. Dati Cliente -->
                <div class="form-section bg-white rounded-lg shadow border border-gray-200 p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-user text-blue-600 mr-2"></i>
                        Dati Cliente
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ragione Sociale *</label>
                            <input type="text" 
                                   x-model="formData.intestazione_cliente.ragione_sociale"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="Nome o Ragione Sociale">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Persona di Riferimento</label>
                            <input type="text" 
                                   x-model="formData.intestazione_cliente.persona_riferimento"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="Nome del referente">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo</label>
                            <div class="space-y-2">
                                <input type="text" 
                                       x-model="formData.intestazione_cliente.indirizzo_via"
                                       @input="updateAnteprima()"
                                       class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                       placeholder="Via e numero civico">
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" 
                                           x-model="formData.intestazione_cliente.indirizzo_cap"
                                           @input="updateAnteprima()"
                                           class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                           placeholder="CAP">
                                    <input type="text" 
                                           x-model="formData.intestazione_cliente.indirizzo_citta"
                                           @input="updateAnteprima()"
                                           class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                           placeholder="CittÃ ">
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="text" 
                                           x-model="formData.intestazione_cliente.indirizzo_provincia"
                                           @input="updateAnteprima()"
                                           class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                           placeholder="Provincia (es. RM)">
                                    <input type="text" 
                                           x-model="formData.intestazione_cliente.indirizzo_nazione"
                                           @input="updateAnteprima()"
                                           value="Italia"
                                           class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                           placeholder="Nazione">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" 
                                   x-model="formData.intestazione_cliente.email"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
                            <input type="tel" 
                                   x-model="formData.intestazione_cliente.telefono"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="+39 xxx xxxxxxx">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">P.IVA / C.F.</label>
                            <input type="text" 
                                   x-model="formData.intestazione_cliente.partita_iva"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="Partita IVA o Codice Fiscale">
                        </div>
                    </div>
                </div>

                <!-- 3. Informazioni Preventivo -->
                <div class="form-section bg-white rounded-lg shadow border border-gray-200 p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                        Informazioni Preventivo
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Oggetto Preventivo *</label>
                            <input type="text" 
                                   x-model="formData.oggetto_preventivo"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                                   placeholder="Descrizione del lavoro/servizio">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Data Scadenza</label>
                            <input type="date" 
                                   x-model="formData.data_scadenza"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                </div>

                <!-- 4. Voci Preventivo -->
                <div class="form-section bg-white rounded-lg shadow border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900">
                            <i class="fas fa-list text-blue-600 mr-2"></i>
                            Voci Preventivo
                        </h3>
                        <button x-on:click="aggiungiVoce()" 
                                class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200">
                            <i class="fas fa-plus mr-1"></i>
                            Aggiungi
                        </button>
                    </div>

                    <!-- Lista Voci Compatta -->
                    <div class="space-y-3">
                        <template x-for="(voce, index) in formData.tabella_preventivo.voci" :key="index">
                            <div class="border rounded-lg p-3 bg-gray-50">
                                <div class="space-y-2">
                                    <textarea x-model="voce.descrizione"
                                              @input="updateRigaTotale(index); updateAnteprima()"
                                              class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                                              rows="2"
                                              placeholder="Descrizione"></textarea>
                                    <div class="grid grid-cols-3 gap-2">
                                        <input type="number" 
                                               x-model.number="voce.quantita"
                                               @input="updateRigaTotale(index); updateAnteprima()"
                                               class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                                               placeholder="QtÃ ">
                                        <input type="number" 
                                               x-model.number="voce.prezzo_unitario"
                                               @input="updateRigaTotale(index); updateAnteprima()"
                                               class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                                               placeholder="Prezzo">
                                        <input type="number" 
                                               x-model.number="voce.sconto_percentuale"
                                               @input="updateRigaTotale(index); updateAnteprima()"
                                               class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                                               placeholder="Sconto %">
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs font-medium" x-text="formatCurrency(voce.totale_riga || 0)"></span>
                                        <button x-on:click="rimuoviVoce(index)" 
                                                class="text-red-600 hover:text-red-900 text-xs">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="formData.tabella_preventivo.voci.length === 0" 
                             class="text-center py-4 text-gray-500 text-sm">
                            Nessuna voce inserita
                        </div>
                    </div>

                    <!-- Totali -->
                    <div x-show="formData.tabella_preventivo.voci.length > 0" 
                         class="mt-4 pt-4 border-t">
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>Imponibile:</span>
                                <span x-text="formatCurrency(formData.sezione_totali.imponibile || 0)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>IVA (22%):</span>
                                <span x-text="formatCurrency(formData.sezione_totali.iva || 0)"></span>
                            </div>
                            <div class="flex justify-between font-semibold text-base border-t pt-1">
                                <span>Totale:</span>
                                <span x-text="formatCurrency(formData.sezione_totali.totale_generale || 0)"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. Condizioni Generali -->
                <div class="form-section bg-white rounded-lg shadow border border-gray-200 p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">
                        <i class="fas fa-file-contract text-blue-600 mr-2"></i>
                        Condizioni Generali
                    </h3>
                    <textarea x-model="formData.condizioni_generali.testo"
                              @input="updateAnteprima()"
                              class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                              rows="4"
                              placeholder="Inserisci le condizioni di pagamento, garanzie, clausole speciali...">
                    </textarea>
                </div>
            </div>
        </div>

        <!-- Area Destra: Documento Full Page -->
        <div class="w-2/3 bg-white overflow-y-auto" id="anteprima-content">
            <!-- L'anteprima verrÃ  caricata qui via HTMX -->
            <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                    <i class="fas fa-file-alt text-4xl mb-4 text-gray-300"></i>
                    <p class="mb-4">Compila i campi per vedere l'anteprima</p>
                    <button x-on:click="rigeneraAnteprima()" 
                            class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-eye mr-2"></i>
                        Genera Anteprima
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function preventivoForm() {
        return {
            salvando: false,
            formData: {
                numero_preventivo: '',
                oggetto_preventivo: '',
                data_scadenza: '',
                stato_preventivo: 'bozza',
                intestazione_azienda: {
                    ragione_sociale: 'La Tua Azienda S.r.l.',
                    partita_iva: '12345678901',
                    indirizzo: 'Via Roma 123, 00100 Roma',
                    telefono: '+39 06 1234567',
                    email: 'info@tuaazienda.it',
                    logo_path: null
                },
                intestazione_cliente: {
                    ragione_sociale: '',
                    persona_riferimento: '',
                    indirizzo_via: '',
                    indirizzo_cap: '',
                    indirizzo_citta: '',
                    indirizzo_provincia: '',
                    indirizzo_nazione: 'Italia',
                    email: '',
                    telefono: '',
                    partita_iva: ''
                },
                tabella_preventivo: {
                    voci: []
                },
                sezione_totali: {
                    imponibile: 0,
                    iva: 0,
                    totale_generale: 0
                },
                condizioni_generali: {
                    testo: 'Pagamento: 30 giorni data fattura.\nValiditÃ  offerta: 30 giorni.\nConsegna: da concordare.'
                },
                footer_preventivo: {
                    note: 'Grazie per averci scelto!',
                    contatti_aggiuntivi: ''
                }
            },

            init() {
                console.log('Alpine.js preventivoForm initialized!');
                
                // Inizializza con una voce vuota
                this.aggiungiVoce();
                
                // Carica dati se Ã¨ una modifica
                const preventivo_id = '{{ preventivo_id or "" }}';
                if (preventivo_id) {
                    this.caricaPreventivo(preventivo_id);
                }
            },

            aggiungiVoce() {
                this.formData.tabella_preventivo.voci.push({
                    descrizione: '',
                    quantita: 1,
                    prezzo_unitario: 0,
                    sconto_percentuale: 0,
                    totale_riga: 0
                });
            },

            rimuoviVoce(index) {
                this.formData.tabella_preventivo.voci.splice(index, 1);
                this.calcolaTotali();
                this.updateAnteprima();
            },

            updateRigaTotale(index) {
                const voce = this.formData.tabella_preventivo.voci[index];
                const subtotale = voce.quantita * voce.prezzo_unitario;
                const sconto = subtotale * (voce.sconto_percentuale / 100);
                voce.totale_riga = subtotale - sconto;
                
                this.calcolaTotali();
            },

            calcolaTotali() {
                const imponibile = this.formData.tabella_preventivo.voci.reduce((sum, voce) => 
                    sum + (voce.totale_riga || 0), 0);
                
                const iva = imponibile * 0.22; // IVA al 22%
                const totale_generale = imponibile + iva;

                this.formData.sezione_totali = {
                    imponibile: Math.round(imponibile * 100) / 100,
                    iva: Math.round(iva * 100) / 100,
                    totale_generale: Math.round(totale_generale * 100) / 100
                };
            },

            // Metodo per convertire il formData nel formato del modello Pydantic
            preparaData() {
                // Calcola i totali prima di preparare i dati
                this.calcolaTotali();
                
                const today = new Date().toISOString().split('T')[0];
                
                // Genera il numero preventivo solo se non esiste giÃ 
                if (!this.formData.numero_preventivo) {
                    this.formData.numero_preventivo = `PREV-${Date.now()}`;
                }
                
                return {
                    metadati_preventivo: {
                        id_preventivo: "00000000-0000-0000-0000-000000000000", // UUID temporaneo
                        numero_preventivo: this.formData.numero_preventivo,
                        data_emissione: today,
                        data_scadenza: this.formData.data_scadenza || null,
                        oggetto_preventivo: this.formData.oggetto_preventivo || '',
                        stato_preventivo: this.formData.stato_preventivo || 'bozza'
                    },
                    azienda_emittente: {
                        nome_azienda: this.formData.intestazione_azienda.ragione_sociale,
                        partita_iva_azienda: this.formData.intestazione_azienda.partita_iva,
                        indirizzo_azienda: {
                            via: "Via Roma 123",
                            cap: "00100",
                            citta: "Roma",
                            provincia: "RM",
                            nazione: "Italia"
                        },
                        email_azienda: "info@tuaazienda.it",
                        telefono_azienda: this.formData.intestazione_azienda.telefono
                    },
                    cliente_destinatario: {
                        nome_cliente: this.formData.intestazione_cliente.ragione_sociale || '',
                        partita_iva: this.formData.intestazione_cliente.partita_iva || null,
                        indirizzo: {
                            via: this.formData.intestazione_cliente.indirizzo_via || '',
                            cap: this.formData.intestazione_cliente.indirizzo_cap || '',
                            citta: this.formData.intestazione_cliente.indirizzo_citta || '',
                            provincia: this.formData.intestazione_cliente.indirizzo_provincia || '',
                            nazione: this.formData.intestazione_cliente.indirizzo_nazione || 'Italia'
                        },
                        email: this.formData.intestazione_cliente.email || null,
                        telefono: this.formData.intestazione_cliente.telefono || null,
                        referente: this.formData.intestazione_cliente.persona_riferimento || null
                    },
                    corpo_preventivo: {
                        righe: this.formData.tabella_preventivo.voci.map(voce => ({
                            descrizione: voce.descrizione || '',
                            quantita: voce.quantita || 1,
                            prezzo_unitario_netto: voce.prezzo_unitario || 0,
                            percentuale_iva: 22,
                            sconto_riga_percentuale: voce.sconto_percentuale || 0
                        }))
                    },
                    condizioni_contrattuali: {
                        testo_condizioni: this.formData.condizioni_generali.testo
                    },
                    dettagli_totali: {
                        totale_imponibile_netto: this.formData.sezione_totali.imponibile,
                        totale_iva: this.formData.sezione_totali.iva,
                        totale_generale_lordo: this.formData.sezione_totali.totale_generale
                    },
                    elementi_footer: {
                        note_finali: this.formData.footer_preventivo.note
                    }
                };
            },

            updateAnteprima() {
                // Debounce per evitare troppe chiamate
                if (this.anteprimaTimeout) {
                    clearTimeout(this.anteprimaTimeout);
                }
                this.anteprimaTimeout = setTimeout(() => {
                    this.rigeneraAnteprima();
                }, 1000);
            },

            async rigeneraAnteprima() {
                try {
                    const data = this.preparaData();
                    
                    const response = await fetch('/preventivo/visualizza', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const html = await response.text();
                        document.getElementById('anteprima-content').innerHTML = html;
                    } else {
                        console.error('Errore nell\'anteprima:', response.status, await response.text());
                    }
                } catch (error) {
                    console.error('Errore nell\'aggiornamento dell\'anteprima:', error);
                }
            },

            async salvaPreventivo(stato = null) {
                try {
                    this.salvando = true;
                    
                    if (stato) {
                        this.formData.stato_preventivo = stato;
                    }

                    const data = this.preparaData();
                    
                    const response = await fetch('/preventivo/salva', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...data,
                            user_id: 'test-user' // TODO: Sostituire con user ID reale
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.formData.numero_preventivo = result.numero_preventivo;
                        showNotification('Preventivo salvato con successo!');
                        
                        // Reindirizza alla dashboard dopo il salvataggio
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        const errorText = await response.text();
                        console.error('Errore nel salvataggio:', response.status, errorText);
                        throw new Error('Errore nel salvataggio');
                    }
                } catch (error) {
                    console.error('Errore nel salvataggio:', error);
                    showNotification('Errore nel salvataggio del preventivo', 'error');
                } finally {
                    this.salvando = false;
                }
            },

            async caricaPreventivo(id) {
                try {
                    const response = await fetch(`/preventivo/${id}?user_id=test-user`);
                    if (response.ok) {
                        const data = await response.json();
                        this.formData = { ...this.formData, ...data };
                        this.rigeneraAnteprima();
                    }
                } catch (error) {
                    console.error('Errore nel caricamento:', error);
                    showNotification('Errore nel caricamento del preventivo', 'error');
                }
            },

            anteprimaPreventivo() {
                // Genera l'anteprima nella colonna di destra
                this.rigeneraAnteprima();
            }
        }
    }
</script>
{% endblock %} 