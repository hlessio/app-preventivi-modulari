{% extends "base.html" %}

{% block title %}{% if preventivo_id %}Modifica{% else %}Nuovo{% endif %} Documento - App Preventivi{% endblock %}

{% block header %}
<!-- Header personalizzato disabilitato - usiamo quello nel main_layout -->
{% endblock %}

{% block extra_head %}
<style>
    .form-section {
        transition: all 0.3s ease;
    }
    .form-section:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    .anteprima-container {
        /* Rimosso max-height e overflow-y */
    }
    .sticky-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: white;
        border-bottom: 1px solid #e5e7eb;
    }
    .sidebar-form {
        /* Custom scrollbar */
        scrollbar-width: thin;
        scrollbar-color: #d1d5db #f9fafb;
    }
    .sidebar-form::-webkit-scrollbar {
        width: 6px;
    }
    .sidebar-form::-webkit-scrollbar-track {
        background: #f9fafb;
    }
    .sidebar-form::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 3px;
    }
    .sidebar-form::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    .documento-area {
        /* Documento area styling */
        box-shadow: -4px 0 8px rgba(0, 0, 0, 0.05);
    }
    .form-input-sm {
        @apply text-xs py-1.5 px-2;
    }
    /* Override del layout base per usare tutta la larghezza */
    .document-fullwidth {
        max-width: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }
</style>
{% endblock %}

{% block main_layout %}
<!-- Layout full-width per la creazione/modifica documenti -->
<div x-data="preventivoForm()" class="flex flex-col h-screen bg-gray-50">
    <!-- Header con Azioni - Full Width -->
    <div class="sticky-header bg-white px-6 py-3 border-b z-10 shadow-sm">
        <div class="flex items-center justify-between w-full">
            <div class="flex items-center space-x-4 flex-1 min-w-0">
                <!-- Logo e titolo app -->
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-file-invoice text-white text-sm"></i>
                    </div>
                    <div class="min-w-0">
                        <input type="text"
                               x-model="formData.nome_documento"
                               @input="updateAnteprima()"
                               class="text-lg font-bold text-gray-900 truncate bg-transparent border-none focus:ring-0 focus:outline-none p-0 m-0"
                               style="width:100%;"
                               placeholder="Nome documento interno..." />
                        <p class="text-xs text-gray-500 truncate">
                            <span x-show="formData.numero_preventivo" x-text="`${formData.numero_preventivo}`"></span>
                            <span x-show="!formData.numero_preventivo">Compilare i campi per creare il documento</span>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Azioni compatte -->
            <div class="flex items-center space-x-2 ml-4">
                <!-- Stato -->
                <select x-model="formData.stato_preventivo" 
                        class="rounded-md border-gray-300 text-xs focus:border-blue-500 focus:ring-blue-500 py-1 px-2">
                    <option value="bozza">Bozza</option>
                    <option value="inviato">Inviato</option>
                    <option value="approvato">Approvato</option>
                    <option value="rifiutato">Rifiutato</option>
                </select>

                <!-- Pulsanti compatti -->
                <button x-on:click="salvaPreventivo('bozza')" 
                        :disabled="salvando"
                        class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50">
                    <i class="fas fa-save mr-1.5" :class="{'fa-spin': salvando}"></i>
                    <span x-text="salvando ? 'Salvando...' : 'Salva'"></span>
                </button>
                
                <button x-on:click="scaricaPdf()" 
                        class="inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
                    <i class="fas fa-file-pdf mr-1.5"></i>
                    PDF
                </button>

                <a href="/" 
                   class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-arrow-left mr-1.5"></i>
                    Dashboard
                </a>
            </div>
        </div>
    </div>

    <div class="flex flex-grow overflow-hidden">
        <!-- Sidebar Sinistra: Controlli Form - Larghezza fissa ottimale -->
        <div class="w-80 flex-shrink-0 bg-white border-r border-gray-200 sidebar-form overflow-y-auto">
            <div class="p-4 space-y-4">
                
                <!-- 1. Dati Azienda (Read-only, precaricati) - Compatto -->
                <div x-show="isModuleVisible('intestazione_azienda')" 
                     class="form-section bg-gray-50 rounded-lg border border-gray-200 p-3" 
                     data-module="intestazione_azienda">
                    <h3 class="text-sm font-semibold text-gray-900 mb-2 flex items-center">
                        <i class="fas fa-building text-blue-600 mr-2 text-xs"></i>
                        Dati Azienda
                    </h3>
                    <div class="space-y-1 text-xs text-gray-600">
                        <div class="flex justify-between">
                            <span class="font-medium">Ragione Sociale:</span>
                            <span x-text="formData.intestazione_azienda.ragione_sociale || 'La Tua Azienda S.r.l.'" class="truncate ml-2"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">P.IVA:</span>
                            <span x-text="formData.intestazione_azienda.partita_iva || '12345678901'"></span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">Telefono:</span>
                            <span x-text="formData.intestazione_azienda.telefono || '+39 06 1234567'"></span>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 italic">
                            <i class="fas fa-info-circle mr-1"></i>
                            Dati dal tuo profilo
                        </p>
                    </div>
                </div>

                <!-- 2. Dati Cliente - Compatto -->
                <div x-show="isModuleVisible('intestazione_cliente')" 
                     class="form-section bg-white rounded-lg shadow-sm border border-gray-200 p-3" 
                     data-module="intestazione_cliente">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-user text-blue-600 mr-2 text-xs"></i>
                        Dati Cliente
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ragione Sociale *</label>
                            <input type="text" 
                                   x-model="formData.intestazione_cliente.ragione_sociale"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                   placeholder="Nome o Ragione Sociale">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Persona di Riferimento</label>
                            <input type="text" 
                                   x-model="formData.intestazione_cliente.persona_riferimento"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                   placeholder="Nome del referente">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" 
                                   x-model="formData.intestazione_cliente.email"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                   placeholder="email@example.com">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Telefono</label>
                            <input type="tel" 
                                   x-model="formData.intestazione_cliente.telefono"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                   placeholder="+39 xxx xxxxxxx">
                        </div>
                        <!-- Indirizzo in forma compatta -->
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Indirizzo</label>
                            <div class="space-y-1">
                                <input type="text" 
                                       x-model="formData.intestazione_cliente.indirizzo_via"
                                       @input="updateAnteprima()"
                                       class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                       placeholder="Via e numero civico">
                                <div class="grid grid-cols-3 gap-1">
                                    <input type="text" 
                                           x-model="formData.intestazione_cliente.indirizzo_cap"
                                           @input="updateAnteprima()"
                                           class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                           placeholder="CAP">
                                    <input type="text" 
                                           x-model="formData.intestazione_cliente.indirizzo_citta"
                                           @input="updateAnteprima()"
                                           class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                           placeholder="Città">
                                    <input type="text" 
                                           x-model="formData.intestazione_cliente.indirizzo_provincia"
                                           @input="updateAnteprima()"
                                           class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                           placeholder="Prov.">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">P.IVA / C.F.</label>
                            <input type="text" 
                                   x-model="formData.intestazione_cliente.partita_iva"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                   placeholder="Partita IVA o Codice Fiscale">
                        </div>
                    </div>
                </div>

                <!-- 3. Informazioni Preventivo - Compatto -->
                <div x-show="isModuleVisible('metadati_preventivo')" 
                     class="form-section bg-white rounded-lg shadow-sm border border-gray-200 p-3" 
                     data-module="metadati_preventivo">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-info-circle text-blue-600 mr-2 text-xs"></i>
                        Info Preventivo
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Oggetto Preventivo *</label>
                            <input type="text" 
                                   x-model="formData.oggetto_preventivo"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm"
                                   placeholder="Descrizione del lavoro/servizio">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Data Scadenza</label>
                            <input type="date" 
                                   x-model="formData.data_scadenza"
                                   @input="updateAnteprima()"
                                   class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 form-input-sm">
                        </div>
                    </div>
                </div>

                <!-- 4. Voci Preventivo - Compatto -->
                <div x-show="isModuleVisible('tabella_preventivo')" 
                     class="form-section bg-white rounded-lg shadow-sm border border-gray-200 p-3" 
                     data-module="tabella_preventivo">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-gray-900 flex items-center">
                            <i class="fas fa-list text-blue-600 mr-2 text-xs"></i>
                            Voci Preventivo
                        </h3>
                        <button x-on:click="aggiungiVoce()" 
                                class="inline-flex items-center px-2 py-1 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200">
                            <i class="fas fa-plus mr-1"></i>
                            Aggiungi
                        </button>
                    </div>

                    <!-- Lista Voci Ultra-Compatta -->
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        <template x-for="(voce, index) in formData.tabella_preventivo.voci" :key="index">
                            <div class="border rounded-md p-2 bg-gray-50">
                                <div class="space-y-1">
                                    <textarea x-model="voce.descrizione"
                                              @input="updateRigaTotale(index); updateAnteprima()"
                                              class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                                              rows="1"
                                              placeholder="Descrizione"></textarea>
                                    <div class="grid grid-cols-4 gap-1">
                                        <input type="number" 
                                               x-model.number="voce.quantita"
                                               @input="updateRigaTotale(index); updateAnteprima()"
                                               class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-1"
                                               placeholder="Qtà">
                                        <input type="number" 
                                               x-model.number="voce.prezzo_unitario"
                                               @input="updateRigaTotale(index); updateAnteprima()"
                                               class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-1"
                                               placeholder="€">
                                        <input type="number" 
                                               x-model.number="voce.sconto_percentuale"
                                               @input="updateRigaTotale(index); updateAnteprima()"
                                               class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs py-1 px-1"
                                               placeholder="%">
                                        <button x-on:click="rimuoviVoce(index)" 
                                                class="text-red-600 hover:text-red-900 text-xs px-1 py-1 rounded hover:bg-red-50">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-xs font-semibold text-green-600" x-text="formatCurrency(voce.totale_riga || 0)"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                        
                        <div x-show="formData.tabella_preventivo.voci.length === 0" 
                             class="text-center py-6 text-gray-500 text-xs">
                            <i class="fas fa-inbox text-2xl text-gray-300 mb-2"></i>
                            <div>Nessuna voce inserita</div>
                        </div>
                    </div>

                    <!-- Totali Compatti -->
                    <div x-show="formData.tabella_preventivo.voci.length > 0" 
                         class="mt-3 pt-3 border-t bg-white rounded p-2">
                        <div class="space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span>Imponibile:</span>
                                <span class="font-medium" x-text="formatCurrency(formData.sezione_totali.imponibile || 0)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span>IVA (22%):</span>
                                <span class="font-medium" x-text="formatCurrency(formData.sezione_totali.iva || 0)"></span>
                            </div>
                            <div class="flex justify-between font-bold text-sm border-t pt-1 text-green-600">
                                <span>Totale:</span>
                                <span x-text="formatCurrency(formData.sezione_totali.totale_generale || 0)"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 5. Condizioni Generali - Compatto -->
                <div x-show="isModuleVisible('condizioni_generali')" 
                     class="form-section bg-white rounded-lg shadow-sm border border-gray-200 p-3" 
                     data-module="condizioni_generali">
                    <h3 class="text-sm font-semibold text-gray-900 mb-2 flex items-center">
                        <i class="fas fa-file-contract text-blue-600 mr-2 text-xs"></i>
                        Condizioni Generali
                    </h3>
                    <textarea x-model="formData.condizioni_generali.testo"
                              @input="updateAnteprima()"
                              class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                              rows="3"
                              placeholder="Inserisci le condizioni di pagamento, garanzie, clausole speciali...">
                    </textarea>
                </div>

                <!-- 6. Footer Preventivo - Compatto -->
                <div x-show="isModuleVisible('footer_preventivo')" 
                     class="form-section bg-white rounded-lg shadow-sm border border-gray-200 p-3" 
                     data-module="footer_preventivo">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-signature text-blue-600 mr-2 text-xs"></i>
                        Footer e Note
                    </h3>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Note Finali</label>
                            <textarea x-model="formData.footer_preventivo.note"
                                      @input="updateAnteprima()"
                                      class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                                      rows="2"
                                      placeholder="Ringraziamenti, saluti, note aggiuntive..."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Contatti Aggiuntivi</label>
                            <textarea x-model="formData.footer_preventivo.contatti_aggiuntivi"
                                      @input="updateAnteprima()"
                                      class="block w-full rounded-md border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-xs"
                                      rows="2"
                                      placeholder="Informazioni di contatto aggiuntive, indirizzi alternativi..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Indicatore moduli nascosti -->
                <div x-show="selectedTemplate" 
                     class="form-section bg-blue-50 rounded-lg border border-blue-200 p-3">
                    <div class="text-center">
                        <div class="text-xs text-blue-700 mb-2">
                            <i class="fas fa-puzzle-piece mr-1"></i>
                            Template attivo: <strong x-text="selectedTemplate?.name"></strong>
                        </div>
                        <div class="text-xs text-blue-600" 
                             x-show="visibleModules.length < 7">
                            <span x-text="7 - visibleModules.length"></span> sezioni nascoste dal template
                        </div>
                        <div class="text-xs text-blue-600" 
                             x-show="visibleModules.length === 7">
                            Tutte le sezioni sono visibili
                        </div>
                        <div class="mt-2 pt-2 border-t border-blue-200">
                            <a href="/" class="text-xs text-blue-600 hover:text-blue-800">
                                <i class="fas fa-arrow-left mr-1"></i>
                                Torna alla dashboard per cambiare template
                            </a>
                        </div>
                    </div>
                </div>
                
                <div x-show="!selectedTemplate" 
                     class="form-section bg-gray-50 rounded-lg border border-gray-200 p-3 text-center">
                    <div class="text-xs text-gray-600">
                        <i class="fas fa-file-alt mr-1"></i>
                        Template standard (tutti i moduli attivi)
                    </div>
                </div>
            </div>
        </div>

        <!-- Area Destra: Documento Full Page - Usa tutto lo spazio rimanente -->
        <div class="flex-1 bg-white documento-area overflow-y-auto" id="anteprima-content">
            <!-- L'anteprima verrà caricata qui via HTMX -->
            <div class="flex items-center justify-center h-full text-gray-500">
                <div class="text-center">
                    <i class="fas fa-file-alt text-6xl mb-6 text-gray-300"></i>
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Anteprima Documento</h3>
                    <p class="mb-6 text-gray-500 max-w-md">Compila i campi nella sidebar sinistra per vedere l'anteprima del preventivo</p>
                    <button x-on:click="rigeneraAnteprima()" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i class="fas fa-eye mr-2"></i>
                        Genera Anteprima
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function preventivoForm() {
        return {
            salvando: false,
            preventivo_id_corrente: null, // ID del documento corrente (per nuovi documenti dopo primo salvataggio)
            availableTemplates: [], // Lista dei template disponibili
            selectedTemplate: null, // Template selezionato completo
            visibleModules: [], // Lista dei moduli visibili basata sul template
            formData: {
                numero_preventivo: '',
                nome_documento: '', // Nome interno del documento per organizzazione
                oggetto_preventivo: '', // Oggetto che appare nel documento per il cliente
                data_scadenza: '',
                stato_preventivo: 'bozza',
                template_id: '', // ID del template selezionato
                intestazione_azienda: {
                    ragione_sociale: 'La Tua Azienda S.r.l.',
                    partita_iva: '12345678901',
                    indirizzo: 'Via Roma 123, 00100 Roma',
                    telefono: '+39 06 1234567',
                    email: 'info@tuaazienda.it',
                    logo_path: null
                },
                intestazione_cliente: {
                    ragione_sociale: '',
                    persona_riferimento: '',
                    indirizzo_via: '',
                    indirizzo_cap: '',
                    indirizzo_citta: '',
                    indirizzo_provincia: '',
                    indirizzo_nazione: 'Italia',
                    email: '',
                    telefono: '',
                    partita_iva: ''
                },
                tabella_preventivo: {
                    voci: []
                },
                sezione_totali: {
                    imponibile: 0,
                    iva: 0,
                    totale_generale: 0
                },
                condizioni_generali: {
                    testo: 'Pagamento: 30 giorni data fattura.\nValidità offerta: 30 giorni.\nConsegna: da concordare.'
                },
                footer_preventivo: {
                    note: 'Grazie per averci scelto!',
                    contatti_aggiuntivi: ''
                }
            },

            init() {
                console.log('Alpine.js preventivoForm initialized!');
                
                // Inizializza nome documento predefinito per nuovi documenti
                const preventivo_id = '{{ preventivo_id or "" }}';
                if (!preventivo_id && !this.formData.nome_documento) {
                    const today = new Date().toLocaleDateString('it-IT');
                    this.formData.nome_documento = `Nuovo Documento - ${today}`;
                }
                
                // Ottieni il template preselezionato dal parametro URL
                const preselectedTemplateId = '{{ preselected_template_id or "" }}';
                
                // SEMPRE carica i template prima, poi i dati del preventivo
                this.loadTemplates().then(() => {
                    console.log('Template caricati, ora carico dati preventivo se necessario');
                    
                    if (preventivo_id) {
                        // È una modifica - carica i dati del preventivo
                        this.caricaPreventivo(preventivo_id);
                    } else if (preselectedTemplateId) {
                        // È un nuovo preventivo con template preselezionato
                        this.formData.template_id = preselectedTemplateId;
                        this.loadTemplateById(preselectedTemplateId);
                    } else {
                        // È un nuovo preventivo normale - inizializza con tutti i moduli visibili
                        this.updateVisibleModules();
                    }
                });
                
                // Inizializza con una voce vuota
                this.aggiungiVoce();
            },

            async loadTemplates() {
                try {
                    console.log('Caricamento template in corso...');
                    const response = await fetch('/templates?user_id=da2cb935-e023-40dd-9703-d918f1066b24&document_type=preventivo');
                    if (response.ok) {
                        const data = await response.json();
                        this.availableTemplates = data || []; // L'API restituisce direttamente un array
                        console.log('Template caricati:', this.availableTemplates.length);
                        
                        // Se non c'è template selezionato, usa il default
                        if (!this.formData.template_id && this.availableTemplates.length > 0) {
                            const defaultTemplate = this.availableTemplates.find(t => t.is_default);
                            if (defaultTemplate) {
                                this.formData.template_id = defaultTemplate.id;
                                this.selectedTemplate = defaultTemplate;
                                this.updateVisibleModules();
                                console.log('Template default selezionato:', defaultTemplate.name);
                            }
                        }
                        return true; // Successo
                    } else {
                        console.error('Errore nel caricamento template:', response.status);
                        return false;
                    }
                } catch (error) {
                    console.error('Errore nel caricamento template:', error);
                    return false;
                }
            },

            async loadTemplateById(templateId) {
                try {
                    const response = await fetch(`/templates/${templateId}?user_id=da2cb935-e023-40dd-9703-d918f1066b24`);
                    if (response.ok) {
                        const template = await response.json();
                        this.selectedTemplate = template;
                        this.updateVisibleModules();
                    } else {
                        console.error('Errore nel caricamento del template:', response.status);
                        // Fallback: carica tutti i template
                        this.loadTemplates();
                    }
                } catch (error) {
                    console.error('Errore nel caricamento del template:', error);
                    // Fallback: carica tutti i template
                    this.loadTemplates();
                }
            },

            updateVisibleModules() {
                // Aggiorna i moduli visibili in base al template selezionato
                if (this.selectedTemplate && this.selectedTemplate.module_composition) {
                    const enabledModules = this.selectedTemplate.module_composition.modules
                        .filter(module => module.enabled)
                        .map(module => module.module_name);
                    
                    this.visibleModules = enabledModules;
                } else {
                    // Se nessun template è selezionato, mostra tutti i moduli
                    this.visibleModules = [
                        'intestazione_azienda',
                        'metadati_preventivo', 
                        'intestazione_cliente',
                        'tabella_preventivo',
                        'sezione_totali',
                        'condizioni_generali',
                        'footer_preventivo'
                    ];
                }
                
                console.log('Moduli visibili:', this.visibleModules);
            },

            onTemplateChange() {
                // Quando cambia il template selezionato
                if (this.formData.template_id) {
                    this.selectedTemplate = this.availableTemplates.find(t => t.id === this.formData.template_id);
                } else {
                    this.selectedTemplate = null;
                }
                
                this.updateVisibleModules();
                this.updateAnteprima();
            },

            isModuleVisible(moduleName) {
                // Verifica se un modulo è visibile
                return this.visibleModules.includes(moduleName);
            },

            aggiungiVoce() {
                this.formData.tabella_preventivo.voci.push({
                    descrizione: '',
                    quantita: 1,
                    prezzo_unitario: 0,
                    sconto_percentuale: 0,
                    totale_riga: 0
                });
            },

            rimuoviVoce(index) {
                this.formData.tabella_preventivo.voci.splice(index, 1);
                this.calcolaTotali();
                this.updateAnteprima();
            },

            updateRigaTotale(index) {
                const voce = this.formData.tabella_preventivo.voci[index];
                const subtotale = voce.quantita * voce.prezzo_unitario;
                const sconto = subtotale * (voce.sconto_percentuale / 100);
                voce.totale_riga = subtotale - sconto;
                
                this.calcolaTotali();
            },

            calcolaTotali() {
                const imponibile = this.formData.tabella_preventivo.voci.reduce((sum, voce) => 
                    sum + (voce.totale_riga || 0), 0);
                
                const iva = imponibile * 0.22; // IVA al 22%
                const totale_generale = imponibile + iva;

                this.formData.sezione_totali = {
                    imponibile: Math.round(imponibile * 100) / 100,
                    iva: Math.round(iva * 100) / 100,
                    totale_generale: Math.round(totale_generale * 100) / 100
                };
            },

            // Metodo per convertire il formData nel formato del modello Pydantic
            preparaData() {
                // Calcola i totali prima di preparare i dati
                this.calcolaTotali();
                
                const today = new Date().toISOString().split('T')[0];
                
                // Genera il numero preventivo solo se non esiste già
                if (!this.formData.numero_preventivo) {
                    this.formData.numero_preventivo = `PREV-${Date.now()}`;
                }
                
                // Aggiungi user_id ai dati
                const datiFormattati = {
                    metadati_preventivo: {
                        id_preventivo: "00000000-0000-0000-0000-000000000000", // UUID temporaneo
                        numero_preventivo: this.formData.numero_preventivo,
                        nome_documento: this.formData.nome_documento,
                        data_emissione: today,
                        data_scadenza: this.formData.data_scadenza || null,
                        oggetto_preventivo: this.formData.oggetto_preventivo || '',
                        stato_preventivo: this.formData.stato_preventivo || 'bozza',
                        template_id: this.formData.template_id || null  // Includi template_id
                    },
                    azienda_emittente: {
                        nome_azienda: this.formData.intestazione_azienda.ragione_sociale,
                        partita_iva_azienda: this.formData.intestazione_azienda.partita_iva,
                        indirizzo_azienda: {
                            via: "Via Roma 123",
                            cap: "00100",
                            citta: "Roma",
                            provincia: "RM",
                            nazione: "Italia"
                        },
                        email_azienda: "info@tuaazienda.it",
                        telefono_azienda: this.formData.intestazione_azienda.telefono
                    },
                    cliente_destinatario: {
                        nome_cliente: this.formData.intestazione_cliente.ragione_sociale || '',
                        partita_iva: this.formData.intestazione_cliente.partita_iva || null,
                        indirizzo: {
                            via: this.formData.intestazione_cliente.indirizzo_via || '',
                            cap: this.formData.intestazione_cliente.indirizzo_cap || '',
                            citta: this.formData.intestazione_cliente.indirizzo_citta || '',
                            provincia: this.formData.intestazione_cliente.indirizzo_provincia || '',
                            nazione: this.formData.intestazione_cliente.indirizzo_nazione || 'Italia'
                        },
                        email: this.formData.intestazione_cliente.email || null,
                        telefono: this.formData.intestazione_cliente.telefono || null,
                        referente: this.formData.intestazione_cliente.persona_riferimento || null
                    },
                    corpo_preventivo: {
                        righe: this.formData.tabella_preventivo.voci.map(voce => ({
                            descrizione: voce.descrizione || '',
                            quantita: voce.quantita || 1,
                            prezzo_unitario_netto: voce.prezzo_unitario || 0,
                            percentuale_iva: 22,
                            sconto_riga_percentuale: voce.sconto_percentuale || 0
                        }))
                    },
                    condizioni_contrattuali: {
                        testo_condizioni: this.formData.condizioni_generali.testo
                    },
                    dettagli_totali: {
                        totale_imponibile_netto: this.formData.sezione_totali.imponibile,
                        totale_iva: this.formData.sezione_totali.iva,
                        totale_generale_lordo: this.formData.sezione_totali.totale_generale
                    },
                    elementi_footer: {
                        note_finali: this.formData.footer_preventivo.note,
                        contatti_aggiuntivi: this.formData.footer_preventivo.contatti_aggiuntivi
                    }
                };
                
                // Aggiungi user_id ai dati
                datiFormattati.user_id = 'da2cb935-e023-40dd-9703-d918f1066b24'; // TODO: Sostituire con user ID reale
                
                return datiFormattati;
            },

            updateAnteprima() {
                // Debounce per evitare troppe chiamate
                if (this.anteprimaTimeout) {
                    clearTimeout(this.anteprimaTimeout);
                }
                this.anteprimaTimeout = setTimeout(() => {
                    this.rigeneraAnteprima();
                }, 1000);
            },

            async rigeneraAnteprima() {
                try {
                    const data = this.preparaData();
                    
                    // Prepara l'URL con il template_id se selezionato
                    let url = '/preventivo/visualizza';
                    if (this.formData.template_id) {
                        url += `?template_id=${this.formData.template_id}`;
                    }
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const html = await response.text();
                        document.getElementById('anteprima-content').innerHTML = html;
                    } else {
                        console.error('Errore nell\'anteprima:', response.status, await response.text());
                    }
                } catch (error) {
                    console.error('Errore nell\'aggiornamento dell\'anteprima:', error);
                }
            },

            async salvaPreventivo(stato = null) {
                try {
                    this.salvando = true;
                    
                    if (stato) {
                        this.formData.stato_preventivo = stato;
                    }

                    const data = this.preparaData();
                    
                    // Determina se è una modifica o un nuovo preventivo
                    const preventivo_id_dalla_pagina = '{{ preventivo_id or "" }}';
                    // Usa l'ID dalla pagina o quello memorizzato dopo un salvataggio precedente
                    const preventivo_id = preventivo_id_dalla_pagina || this.preventivo_id_corrente;
                    const isUpdate = !!preventivo_id;
                    
                    let url, method;
                    if (isUpdate) {
                        url = `/preventivo/${preventivo_id}/aggiorna?user_id=da2cb935-e023-40dd-9703-d918f1066b24`;
                        method = 'PUT';
                    } else {
                        url = '/preventivo/salva';
                        method = 'POST';
                    }
                    
                    console.log(`Salvataggio: ${isUpdate ? 'UPDATE' : 'CREATE'}, ID: ${preventivo_id}, URL: ${url}`);
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        this.formData.numero_preventivo = result.numero_preventivo;
                        
                        // IMPORTANTE: Memorizza l'ID dopo il primo salvataggio
                        if (!isUpdate && result.preventivo_id) {
                            this.preventivo_id_corrente = result.preventivo_id;
                            console.log('ID documento memorizzato:', result.preventivo_id);
                        }
                        
                        showNotification(isUpdate ? 'Documento aggiornato con successo!' : 'Documento salvato con successo!');
                        
                        // Reindirizza alla dashboard dopo il salvataggio
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 1500);
                    } else {
                        const errorText = await response.text();
                        console.error('Errore nel salvataggio:', response.status, errorText);
                        throw new Error('Errore nel salvataggio');
                    }
                } catch (error) {
                    console.error('Errore nel salvataggio:', error);
                    showNotification('Errore nel salvataggio del documento', 'error');
                } finally {
                    this.salvando = false;
                }
            },

            async caricaPreventivo(id) {
                try {
                    console.log('Caricamento preventivo ID:', id);
                    const response = await fetch(`/preventivo/${id}?user_id=da2cb935-e023-40dd-9703-d918f1066b24`);
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Dati preventivo caricati:', data);
                        
                        // Aggiorna formData con i dati caricati, mantenendo la struttura esistente
                        this.formData = { ...this.formData, ...data };
                        
                        // Gestisci specificamente il nome_documento dai metadati
                        if (data.metadati_preventivo) {
                            if (data.metadati_preventivo.nome_documento) {
                                this.formData.nome_documento = data.metadati_preventivo.nome_documento;
                                console.log('Nome documento caricato:', this.formData.nome_documento);
                            }
                            if (data.metadati_preventivo.template_id) {
                                this.formData.template_id = data.metadati_preventivo.template_id;
                                console.log('Template ID dal preventivo:', this.formData.template_id);
                                console.log('Template disponibili:', this.availableTemplates.length);
                                
                                // Trova il template completo nella lista
                                this.selectedTemplate = this.availableTemplates.find(t => t.id === this.formData.template_id);
                                if (this.selectedTemplate) {
                                    console.log('Template trovato e selezionato:', this.selectedTemplate.name);
                                    this.updateVisibleModules();
                                } else {
                                    console.warn('Template non trovato nella lista disponibili, ID:', this.formData.template_id);
                                    // Fallback: carica tutti i moduli
                                    this.updateVisibleModules();
                                }
                            } else {
                                console.log('Nessun template_id nel preventivo, uso default');
                                this.updateVisibleModules();
                            }
                        }
                        
                        this.rigeneraAnteprima();
                    }
                } catch (error) {
                    console.error('Errore nel caricamento:', error);
                    showNotification('Errore nel caricamento del documento', 'error');
                }
            },

            async scaricaPdf() {
                try {
                    const preventivo_id = '{{ preventivo_id or "" }}';
                    
                    if (preventivo_id) {
                        // Preventivo esistente - usa endpoint GET
                        const response = await fetch(`/preventivo/${preventivo_id}/pdf?user_id=da2cb935-e023-40dd-9703-d918f1066b24`);
                        
                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `preventivo_${this.formData.numero_preventivo || preventivo_id}.pdf`;
                            a.click();
                            window.URL.revokeObjectURL(url);
                            showNotification('PDF scaricato con successo!');
                        } else {
                            throw new Error(`Errore ${response.status}: ${await response.text()}`);
                        }
                    } else {
                        // Preventivo nuovo - usa endpoint POST con dati attuali
                        const data = this.preparaData();
                        
                        const response = await fetch('/preventivo/pdf', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(data)
                        });

                        if (response.ok) {
                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = `preventivo_${this.formData.numero_preventivo || 'nuovo'}.pdf`;
                            a.click();
                            window.URL.revokeObjectURL(url);
                            showNotification('PDF generato e scaricato con successo!');
                        } else {
                            throw new Error(`Errore ${response.status}: ${await response.text()}`);
                        }
                    }
                } catch (error) {
                    console.error('Errore nel download del PDF:', error);
                    showNotification(`Errore nel download del PDF: ${error.message}`, 'error');
                }
            },

            // Funzione di utilità per formattare valute
            formatCurrency(value) {
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value || 0);
            }
        }
    }
</script> 
{% endblock %} 