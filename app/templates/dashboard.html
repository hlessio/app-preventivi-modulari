{% extends "base.html" %}

{% block title %}Dashboard - App Preventivi{% endblock %}

{% block content %}
<div x-data="dashboardData()" class="flex h-screen bg-gray-50">
    <!-- Sidebar Cartelle -->
    <div class="w-80 bg-white shadow-lg flex flex-col border-r border-gray-200">
        <!-- Header Sidebar -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold text-gray-900">Cartelle</h3>
                <button @click="mostraModaleNuovaCartella = true" 
                        class="inline-flex items-center rounded-md bg-blue-600 px-2 py-1 text-xs font-semibold text-white shadow-sm hover:bg-blue-500">
                    <i class="fas fa-plus mr-1"></i>
                    Nuova
                </button>
            </div>
        </div>

        <!-- Lista Cartelle -->
        <div class="flex-1 overflow-y-auto p-4">
            <!-- Cartella "Tutti i preventivi" -->
            <div @click="selezionaCartella(null)" 
                 :class="{'bg-blue-50 border-blue-200 text-blue-700': cartellaSelezionata === null, 'hover:bg-gray-50': cartellaSelezionata !== null}"
                 class="flex items-center justify-between p-3 rounded-lg border cursor-pointer mb-2">
                <div class="flex items-center">
                    <i class="fas fa-list-ul text-gray-600 mr-3"></i>
                    <span class="font-medium">Tutti i preventivi</span>
                </div>
                <span class="text-sm text-gray-500" x-text="totalePreventiviAttivi"></span>
            </div>

            <!-- Cartella "Senza cartella" -->
            <div @click="selezionaCartella('none')" 
                 :class="{'bg-blue-50 border-blue-200 text-blue-700': cartellaSelezionata === 'none', 'hover:bg-gray-50': cartellaSelezionata !== 'none'}"
                 class="flex items-center justify-between p-3 rounded-lg border cursor-pointer mb-3">
                <div class="flex items-center">
                    <i class="fas fa-inbox text-gray-600 mr-3"></i>
                    <span class="font-medium">Senza cartella</span>
                </div>
                <span class="text-sm text-gray-500" x-text="preventivisSenzaCartella"></span>
            </div>

            <!-- Cartelle personalizzate -->
            <div class="space-y-2">
                <template x-for="cartella in cartelle" :key="cartella.id">
                    <div @click="selezionaCartella(cartella.id)" 
                         :class="{'bg-blue-50 border-blue-200 text-blue-700': cartellaSelezionata === cartella.id, 'hover:bg-gray-50': cartellaSelezionata !== cartella.id}"
                         class="group flex items-center justify-between p-3 rounded-lg border cursor-pointer">
                        <div class="flex items-center flex-1 min-w-0">
                            <i :class="cartella.icona || 'fas fa-folder'" 
                               :style="cartella.colore ? `color: ${cartella.colore}` : ''"
                               class="mr-3 text-gray-600"></i>
                            <span class="font-medium truncate" x-text="cartella.nome"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500" x-text="cartella.numero_preventivi"></span>
                            <div class="hidden group-hover:flex items-center space-x-1">
                                <button @click.stop="modificaCartella(cartella)" 
                                        class="p-1 rounded hover:bg-gray-200">
                                    <i class="fas fa-edit text-xs text-gray-500"></i>
                                </button>
                                <button @click.stop="eliminaCartella(cartella.id)" 
                                        class="p-1 rounded hover:bg-gray-200">
                                    <i class="fas fa-trash text-xs text-red-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Tab Vista (Attivi/Cestino) -->
        <div class="border-t border-gray-200 p-4">
            <div class="flex space-x-1 border border-gray-300 rounded-md p-1">
                <button @click="switchView('attivi')" 
                        :class="{'bg-blue-600 text-white': currentView === 'attivi', 'bg-gray-100 text-gray-700 hover:bg-gray-200': currentView !== 'attivi'}"
                        class="flex-1 px-3 py-2 text-sm font-medium rounded-md focus:outline-none">
                    <i class="fas fa-list-ul mr-2"></i>Attivi
                </button>
                <button @click="switchView('cestinati')" 
                        :class="{'bg-red-600 text-white': currentView === 'cestinati', 'bg-gray-100 text-gray-700 hover:bg-gray-200': currentView !== 'cestinati'}"
                        class="flex-1 px-3 py-2 text-sm font-medium rounded-md focus:outline-none">
                    <i class="fas fa-trash mr-2"></i>Cestino
                </button>
            </div>
        </div>
    </div>

    <!-- Contenuto Principale -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-semibold text-gray-900">
                        <span x-show="currentView === 'attivi'">Preventivi Attivi</span>
                        <span x-show="currentView === 'cestinati'">Cestino</span>
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">
                        <span x-show="cartellaSelezionata === null">Tutti i preventivi</span>
                        <span x-show="cartellaSelezionata === 'none'">Preventivi senza cartella</span>
                        <span x-show="cartellaSelezionata && cartellaSelezionata !== 'none'" x-text="getNomeCartellaSelezionata()"></span>
                    </p>
                </div>
                <div class="flex items-center space-x-3">
                <a href="/templates/composer" 
                   class="inline-flex items-center rounded-md bg-purple-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-purple-500">
                    <i class="fas fa-cogs mr-2"></i>
                    Template Composer
                </a>
                <a href="/preventivo/nuovo" 
                   x-show="currentView === 'attivi'"
                   class="inline-flex items-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                    <i class="fas fa-plus mr-2"></i>
                    Nuovo Preventivo
                </a>
                    <!-- Pulsante Svuota Cestino (mostra solo in vista cestino) -->
                    <button x-show="currentView === 'cestinati'" 
                            @click="svuotaTuttoCestino()" 
                            class="inline-flex items-center rounded-md bg-red-500 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-700">
                        <i class="fas fa-eraser mr-2"></i>Svuota Tutto
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="bg-white px-6 py-4 border-b border-gray-200">
            <div x-show="currentView === 'attivi'" class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-3 border">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                            <i class="fas fa-file-invoice text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">Preventivi Attivi</p>
                            <p class="text-lg font-semibold text-gray-900" x-text="stats.totali || 0">0</p>
                    </div>
                </div>
            </div>

                <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-3 border">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                            <i class="fas fa-clock text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">In Attesa</p>
                            <p class="text-lg font-semibold text-gray-900" x-text="stats.in_attesa || 0">0</p>
                    </div>
                </div>
            </div>

                <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-3 border">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">Approvati</p>
                            <p class="text-lg font-semibold text-gray-900" x-text="stats.approvati || 0">0</p>
                    </div>
                </div>
            </div>

                <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-3 border">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                            <i class="fas fa-euro-sign text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">Valore Totale</p>
                            <p class="text-lg font-semibold text-gray-900" x-text="formatCurrency(stats.valore_totale || 0)">€0,00</p>
                    </div>
                    </div>
                </div>
            </div>
            
            <div x-show="currentView === 'cestinati'" class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                <div class="overflow-hidden rounded-lg bg-gray-50 px-4 py-3 border">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                            <i class="fas fa-trash-alt text-red-600 text-xl"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-500">Nel Cestino</p>
                            <p class="text-lg font-semibold text-gray-900" x-text="stats.totali || 0">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtri e Ricerca -->
        <div class="bg-white px-6 py-4 border-b border-gray-200">
            <div class="flex items-center space-x-4">
            <!-- Ricerca -->
                <div class="flex-1">
                    <div class="relative">
                    <input 
                        type="text" 
                        x-model="filters.search"
                        @input.debounce.500ms="loadPreventivi()"
                            class="block w-full rounded-md border-gray-300 pl-10 pr-3 py-2 text-sm focus:border-blue-500 focus:ring-blue-500"
                        placeholder="Cerca per numero, cliente, oggetto..."
                    >
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                </div>
            </div>

            <!-- Filtro Stato -->
                <div class="w-48">
                <select 
                    x-model="filters.stato"
                    @change="loadPreventivi()"
                        class="block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-sm focus:border-blue-500 focus:ring-blue-500"
                >
                    <option value="">Tutti gli stati</option>
                    <option value="bozza">Bozza</option>
                    <option value="inviato">Inviato</option>
                    <option value="approvato">Approvato</option>
                    <option value="rifiutato">Rifiutato</option>
                    <option value="scaduto">Scaduto</option>
                </select>
            </div>

            <!-- Ordinamento -->
                <div class="w-48">
                <select 
                    x-model="filters.sort"
                    @change="loadPreventivi()"
                        class="block w-full rounded-md border-gray-300 py-2 pl-3 pr-10 text-sm focus:border-blue-500 focus:ring-blue-500"
                >
                    <option value="created_at_desc">Più recenti</option>
                    <option value="created_at_asc">Più vecchi</option>
                        <option value="numero_asc">Numero (A-Z)</option>
                        <option value="numero_desc">Numero (Z-A)</option>
                        <option value="cliente_asc">Cliente (A-Z)</option>
                        <option value="valore_desc">Valore (Alto-Basso)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Lista Preventivi -->
        <div class="flex-1 overflow-y-auto bg-gray-50">
            <!-- Loading Spinner -->
            <div x-show="loading" class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
            </div>

            <!-- Lista Preventivi -->
            <div x-show="!loading" class="p-6">
                <div x-show="preventivi.length === 0" class="text-center py-12">
                    <i class="fas fa-file-invoice text-gray-400 text-4xl mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Nessun preventivo trovato</h3>
                    <p class="text-gray-500 mb-4">
                        <span x-show="currentView === 'attivi'">Non ci sono preventivi in questa sezione.</span>
                        <span x-show="currentView === 'cestinati'">Il cestino è vuoto.</span>
                    </p>
                    <a href="/preventivo/nuovo" 
                       x-show="currentView === 'attivi'"
                       class="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                        <i class="fas fa-plus mr-2"></i>
                        Crea Primo Preventivo
                    </a>
                </div>

                <!-- Griglia Preventivi -->
                <div x-show="preventivi.length > 0" class="grid grid-cols-1 gap-4">
                    <template x-for="preventivo in preventivi" :key="preventivo.id">
                        <div class="bg-white rounded-lg shadow border border-gray-200 p-6">
                            <div class="flex items-start justify-between">
                                <!-- Info Principale -->
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center space-x-2 mb-2">
                                        <h3 class="text-lg font-semibold text-gray-900 truncate" x-text="preventivo.numero_preventivo"></h3>
                                        <span :class="getStatoClass(preventivo.stato_preventivo)" 
                                              class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                              x-text="preventivo.stato_preventivo"></span>
                                        <!-- Badge Cartella -->
                                        <span x-show="preventivo.cartella_nome" 
                                              :style="preventivo.cartella_colore ? `background-color: ${preventivo.cartella_colore}20; color: ${preventivo.cartella_colore}; border-color: ${preventivo.cartella_colore}` : ''"
                                              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700 border">
                                            <i class="fas fa-folder mr-1"></i>
                                            <span x-text="preventivo.cartella_nome"></span>
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 mb-1" x-text="preventivo.oggetto_preventivo"></p>
                                    <p class="text-sm text-gray-500">Cliente: <span x-text="preventivo.nome_cliente || 'N/A'"></span></p>
                                    <div class="flex items-center space-x-4 mt-3">
                                        <p class="text-sm text-gray-500">
                                            <span x-show="currentView === 'attivi'">Creato: </span>
                                            <span x-show="currentView === 'cestinati'">Cestinato: </span>
                                            <span x-text="formatDate(currentView === 'attivi' ? preventivo.created_at : preventivo.cestinato_il)"></span>
                                        </p>
                                        <p class="text-sm font-medium text-gray-900" x-text="formatCurrency(preventivo.valore_totale_lordo || 0)"></p>
                                    </div>
                                </div>

                                <!-- Azioni -->
                                <div class="flex items-center space-x-2 ml-4">
                                    <!-- Dropdown Spostamento in Cartella (solo vista attivi) -->
                                    <div x-show="currentView === 'attivi'" class="relative" x-data="{ showDropdown: false }">
                                        <button @click="showDropdown = !showDropdown" 
                                                class="inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-200">
                                            <i class="fas fa-folder mr-1"></i>
                                            Cartella
                                        </button>
                                        <div x-show="showDropdown" 
                                             @click.away="showDropdown = false"
                                             class="absolute right-0 z-10 mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg">
                                            <div class="py-1">
                                                <button @click="spostaInCartella(preventivo.id, null); showDropdown = false" 
                                                        class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                    <i class="fas fa-inbox mr-2"></i>Rimuovi da cartella
                                                </button>
                                                <template x-for="cartella in cartelle" :key="cartella.id">
                                                    <button @click="spostaInCartella(preventivo.id, cartella.id); showDropdown = false" 
                                                            class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                        <i :class="cartella.icona || 'fas fa-folder'" class="mr-2"></i>
                                                        <span x-text="cartella.nome"></span>
                                                    </button>
                                                </template>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Azioni standard -->
                                    <div x-show="currentView === 'attivi'" class="flex space-x-1">
                                        <a :href="`/preventivo/${preventivo.id}/visualizza`" 
                                           class="inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-700 hover:bg-gray-200">
                                            <i class="fas fa-eye mr-1"></i>Visualizza
                                        </a>
                                        <a :href="`/preventivo/${preventivo.id}/modifica`" 
                                           class="inline-flex items-center rounded-md bg-blue-100 px-2 py-1 text-xs font-medium text-blue-700 hover:bg-blue-200">
                                            <i class="fas fa-edit mr-1"></i>Modifica
                                        </a>
                                        <a :href="`/preventivo/${preventivo.id}/pdf`" 
                                           class="inline-flex items-center rounded-md bg-green-100 px-2 py-1 text-xs font-medium text-green-700 hover:bg-green-200">
                                            <i class="fas fa-file-pdf mr-1"></i>PDF
                                        </a>
                                        <button @click="cestinaPreventivo(preventivo.id)" 
                                                class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-700 hover:bg-red-200">
                                            <i class="fas fa-trash mr-1"></i>Cestina
                                        </button>
                                    </div>

                                    <div x-show="currentView === 'cestinati'" class="flex space-x-1">
                                        <button @click="ripristinaPreventivo(preventivo.id)" 
                                                class="inline-flex items-center rounded-md bg-green-100 px-2 py-1 text-xs font-medium text-green-700 hover:bg-green-200">
                                            <i class="fas fa-undo mr-1"></i>Ripristina
                                        </button>
                                        <button @click="eliminaDefinitivamentePreventivo(preventivo.id)" 
                                                class="inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-700 hover:bg-red-200">
                                            <i class="fas fa-trash-alt mr-1"></i>Elimina
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Modale Nuova Cartella -->
    <div x-show="mostraModaleNuovaCartella" 
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" 
         style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Nuova Cartella</h3>
                <form @submit.prevent="creaCartella()">
                    <div class="mb-4">
                        <label for="nome_cartella" class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" 
                               id="nome_cartella"
                               x-model="nuovaCartella.nome"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                               required>
                    </div>
                    <div class="mb-4">
                        <label for="descrizione_cartella" class="block text-sm font-medium text-gray-700">Descrizione (opzionale)</label>
                        <textarea id="descrizione_cartella"
                                  x-model="nuovaCartella.descrizione"
                                  rows="2"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="colore_cartella" class="block text-sm font-medium text-gray-700">Colore</label>
                        <input type="color" 
                               id="colore_cartella"
                               x-model="nuovaCartella.colore"
                               class="mt-1 block w-full h-10 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="icona_cartella" class="block text-sm font-medium text-gray-700">Icona</label>
                        <select id="icona_cartella"
                                x-model="nuovaCartella.icona"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="fas fa-folder">📁 Cartella</option>
                            <option value="fas fa-briefcase">💼 Business</option>
                            <option value="fas fa-star">⭐ Stella</option>
                            <option value="fas fa-heart">❤️ Cuore</option>
                            <option value="fas fa-home">🏠 Casa</option>
                            <option value="fas fa-building">🏢 Edificio</option>
                            <option value="fas fa-users">👥 Utenti</option>
                            <option value="fas fa-cog">⚙️ Impostazioni</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" 
                                @click="mostraModaleNuovaCartella = false; resetNuovaCartella()"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Annulla
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Crea Cartella
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modale Modifica Cartella -->
    <div x-show="mostraModaleModificaCartella" 
         class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" 
         style="display: none;">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Modifica Cartella</h3>
                <form @submit.prevent="salvaModificheCartella()">
                    <div class="mb-4">
                        <label for="modifica_nome_cartella" class="block text-sm font-medium text-gray-700">Nome</label>
                        <input type="text" 
                               id="modifica_nome_cartella"
                               x-model="cartellaInModifica.nome"
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                               required>
                    </div>
                    <div class="mb-4">
                        <label for="modifica_descrizione_cartella" class="block text-sm font-medium text-gray-700">Descrizione</label>
                        <textarea id="modifica_descrizione_cartella"
                                  x-model="cartellaInModifica.descrizione"
                                  rows="2"
                                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="modifica_colore_cartella" class="block text-sm font-medium text-gray-700">Colore</label>
                        <input type="color" 
                               id="modifica_colore_cartella"
                               x-model="cartellaInModifica.colore"
                               class="mt-1 block w-full h-10 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="modifica_icona_cartella" class="block text-sm font-medium text-gray-700">Icona</label>
                        <select id="modifica_icona_cartella"
                                x-model="cartellaInModifica.icona"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            <option value="fas fa-folder">📁 Cartella</option>
                            <option value="fas fa-briefcase">💼 Business</option>
                            <option value="fas fa-star">⭐ Stella</option>
                            <option value="fas fa-heart">❤️ Cuore</option>
                            <option value="fas fa-home">🏠 Casa</option>
                            <option value="fas fa-building">🏢 Edificio</option>
                            <option value="fas fa-users">👥 Utenti</option>
                            <option value="fas fa-cog">⚙️ Impostazioni</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button type="button" 
                                @click="mostraModaleModificaCartella = false"
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Annulla
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Salva Modifiche
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function dashboardData() {
        return {
            loading: true,
            preventivi: [],
            currentView: 'attivi', // 'attivi' o 'cestinati'
            stats: {
                totali: 0,
                in_attesa: 0,
                approvati: 0,
                valore_totale: 0
            },
            filters: {
                search: '',
                stato: '',
                sort: 'created_at_desc'
            },
            cartellaSelezionata: null,
            cartelle: [],
            totalePreventiviAttivi: 0,
            preventivisSenzaCartella: 0,
            mostraModaleNuovaCartella: false,
            mostraModaleModificaCartella: false,
            nuovaCartella: {
                nome: '',
                descrizione: '',
                colore: '#007bff',
                icona: 'fas fa-folder'
            },
            cartellaInModifica: {
                id: '',
                nome: '',
                descrizione: '',
                colore: '#007bff',
                icona: 'fas fa-folder'
            },

            init() {
                this.loadPreventivi();
                this.loadCartelle();
            },

            async loadCartelle() {
                try {
                    const response = await fetch('/cartelle?user_id=da2cb935-e023-40dd-9703-d918f1066b24');
                    if (!response.ok) {
                        throw new Error('Errore nel caricamento delle cartelle');
                    }
                    const data = await response.json();
                    this.cartelle = data || [];
                    this.aggiornaCosatiCartelle();
                } catch (error) {
                    console.error('Errore nel caricamento cartelle:', error);
                    this.cartelle = [];
                }
            },

            aggiornaCosatiCartelle() {
                // Calcola conteggi per sidebar
                this.totalePreventiviAttivi = this.preventivi.length;
                this.preventivisSenzaCartella = this.preventivi.filter(p => !p.cartella_id).length;
            },

            async loadPreventivi() {
                try {
                    this.loading = true;
                    let endpoint = '/preventivi/con-cartelle';

                    const params = new URLSearchParams({
                        user_id: 'da2cb935-e023-40dd-9703-d918f1066b24',
                        stato_record: this.currentView === 'attivi' ? 'attivo' : 'cestinato',
                        ...this.filters 
                    });

                    // Aggiungi filtro cartella se selezionata
                    if (this.cartellaSelezionata !== null) {
                        params.append('cartella_id', this.cartellaSelezionata);
                    }
                    
                    const response = await fetch(`${endpoint}?${params}`);
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore dal server');
                    }
                    const data = await response.json();
                    
                    this.preventivi = data || []; 
                    this.updateStats();
                    this.aggiornaCosatiCartelle();

                } catch (error) {
                    console.error('Errore nel caricamento preventivi:', error);
                    showNotification(error.message || 'Errore nel caricamento dei preventivi', 'error');
                    this.preventivi = [];
                } finally {
                    this.loading = false;
                }
            },

            updateStats() {
                if (this.currentView === 'attivi') {
                    let valoreComplessivoAttivi = 0;
                    if (this.preventivi && this.preventivi.length > 0) {
                         valoreComplessivoAttivi = this.preventivi.reduce((sum, p) => sum + (p.valore_totale_lordo || 0), 0);
                    }
                    this.stats = {
                        totali: this.preventivi.length,
                        in_attesa: this.preventivi.filter(p => p.stato_preventivo === 'inviato').length,
                        approvati: this.preventivi.filter(p => p.stato_preventivo === 'approvato').length,
                        valore_totale: valoreComplessivoAttivi
                    };
                } else {
                    this.stats = {
                        totali: this.preventivi.length, 
                        in_attesa: 0,
                        approvati: 0,
                        valore_totale: 0
                    };
                }
            },

            switchView(view) {
                this.currentView = view;
                this.cartellaSelezionata = null;
                this.loadPreventivi();
            },

            getStatoClass(stato) {
                const classes = {
                    'bozza': 'bg-gray-100 text-gray-800',
                    'inviato': 'bg-blue-100 text-blue-800',
                    'approvato': 'bg-green-100 text-green-800',
                    'rifiutato': 'bg-red-100 text-red-800',
                    'scaduto': 'bg-yellow-100 text-yellow-800'
                };
                return classes[stato] || classes['bozza'];
            },

            formatDate(dateString) {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('it-IT');
            },

            formatCurrency(value) {
                if (typeof value !== 'number') {
                    value = 0;
                }
                return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
            },

            async duplicaPreventivo(id) {
                if (!confirm('Sei sicuro di voler duplicare questo preventivo?')) return;
                try {
                    showNotification('Funzionalità duplicazione preventivo non ancora implementata.', 'info');
                } catch (error) {
                    showNotification('Errore nella duplicazione', 'error');
                }
            },

            async cestinaPreventivo(id) {
                if (!confirm('Sei sicuro di voler spostare questo preventivo nel cestino?')) return;
                try {
                    const response = await fetch(`/preventivo/${id}/cestina?user_id=da2cb935-e023-40dd-9703-d918f1066b24`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante lo spostamento nel cestino');
                    }
                    showNotification('Preventivo spostato nel cestino', 'success');
                    this.loadPreventivi();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            },

            async ripristinaPreventivo(id) {
                if (!confirm('Sei sicuro di voler ripristinare questo preventivo?')) return;
                try {
                    const response = await fetch(`/preventivo/${id}/ripristina?user_id=da2cb935-e023-40dd-9703-d918f1066b24`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante il ripristino');
                    }
                    showNotification('Preventivo ripristinato con successo', 'success');
                    this.loadPreventivi();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            },

            async eliminaDefinitivamentePreventivo(id) {
                if (!confirm('Sei sicuro di voler eliminare DEFINITIVAMENTE questo preventivo? L\'azione non può essere annullata.')) return;
                try {
                    const response = await fetch(`/preventivo/${id}/definitivo?user_id=da2cb935-e023-40dd-9703-d918f1066b24`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante l\'eliminazione definitiva');
                    }
                    showNotification('Preventivo eliminato definitivamente', 'success');
                    this.loadPreventivi();
                } catch (error) {
                    showNotification(error.message, 'error');
                }
            },

            async svuotaTuttoCestino() {
                if (!confirm('Sei sicuro di voler eliminare definitivamente tutti i preventivi nel cestino?')) return;
                try {
                    const response = await fetch('/preventivi/cestino/svuota_tutto?user_id=da2cb935-e023-40dd-9703-d918f1066b24', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante lo svuotamento del cestino');
                    }
                    const result = await response.json();
                    showNotification(`${result.count} preventivi eliminati dal cestino.`, 'success');
                    this.loadPreventivi();
                } catch (error) {
                    showNotification(error.message || 'Errore svuotamento cestino', 'error');
                }
            },

            selezionaCartella(id) {
                this.cartellaSelezionata = id;
                this.loadPreventivi();
            },

            async creaCartella() {
                try {
                    const response = await fetch('/cartelle?user_id=da2cb935-e023-40dd-9703-d918f1066b24', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.nuovaCartella)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante la creazione della cartella');
                    }
                    const result = await response.json();
                    showNotification('Cartella creata con successo', 'success');
                    this.mostraModaleNuovaCartella = false;
                    this.resetNuovaCartella();
                    this.loadCartelle();
                } catch (error) {
                    showNotification(error.message || 'Errore creazione cartella', 'error');
                }
            },

            resetNuovaCartella() {
                this.nuovaCartella = {
                    nome: '',
                    descrizione: '',
                    colore: '#007bff',
                    icona: 'fas fa-folder'
                };
            },

            async modificaCartella(cartella) {
                this.cartellaInModifica = { ...cartella };
                this.mostraModaleModificaCartella = true;
            },

            async salvaModificheCartella() {
                try {
                    const response = await fetch(`/cartelle/${this.cartellaInModifica.id}?user_id=da2cb935-e023-40dd-9703-d918f1066b24`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.cartellaInModifica)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante la modifica della cartella');
                    }
                    const result = await response.json();
                    showNotification('Cartella modificata con successo', 'success');
                    this.mostraModaleModificaCartella = false;
                    this.loadCartelle();
                } catch (error) {
                    showNotification(error.message || 'Errore modifica cartella', 'error');
                }
            },

            async eliminaCartella(id) {
                if (!confirm('Sei sicuro di voler eliminare questa cartella? I preventivi al suo interno verranno spostati in "Senza cartella".')) return;
                try {
                    const response = await fetch(`/cartelle/${id}?user_id=da2cb935-e023-40dd-9703-d918f1066b24`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante l\'eliminazione della cartella');
                    }
                    showNotification('Cartella eliminata con successo', 'success');
                    if (this.cartellaSelezionata === id) {
                        this.cartellaSelezionata = null;
                    }
                    this.loadCartelle();
                    this.loadPreventivi();
                } catch (error) {
                    showNotification(error.message || 'Errore eliminazione cartella', 'error');
                }
            },

            async spostaInCartella(preventivoId, cartellaId) {
                try {
                    const response = await fetch(`/preventivo/${preventivoId}/sposta-cartella?user_id=da2cb935-e023-40dd-9703-d918f1066b24&cartella_id=${cartellaId || ''}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Errore durante lo spostamento del preventivo');
                    }
                    showNotification('Preventivo spostato con successo', 'success');
                    this.loadPreventivi();
                    this.loadCartelle();
                } catch (error) {
                    showNotification(error.message || 'Errore spostamento preventivo', 'error');
                }
            },

            getNomeCartellaSelezionata() {
                const cartella = this.cartelle.find(c => c.id === this.cartellaSelezionata);
                return cartella ? cartella.nome : '';
            }
        }
    }
</script>
{% endblock %} 